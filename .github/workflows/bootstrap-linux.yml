name: bootstrap-linux

on: [push, pull_request]

env:
  CACHE_VERSION: 1
  CT_ALLOW_BUILD_AS_ROOT_SURE: 1
  DEBIAN_FRONTEND: noninteractive
  FORCE_UNSAFE_CONFIGURE: 1

jobs:
  bootstrap:
    strategy:
      matrix:
        container: [debian:11, debian:12, debian:13, ubuntu:20.04, ubuntu:22.04, ubuntu:24.04]
        platform: [darkglass-anagram, darkglass-anagram-debug]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.container }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up cache
        uses: actions/cache@v4
        with:
          path: |
            ~/mod-workdir
          key: bootstrap-linux-${{ matrix.platform }}-${{ matrix.container }}-v${{ env.CACHE_VERSION }}
      - name: Install dependencies
        run: |
          apt-get update -qq && apt-get install -yqq \
            acl bc curl cvs git mercurial rsync subversion wget \
            bison bzip2 flex gawk gperf gzip help2man nano perl patch tar texinfo unzip \
            automake binutils build-essential cpio libtool libncurses-dev pkg-config python-is-python3 libtool-bin
      - name: Clone mod-plugin-builder
        run: |
          git clone https://github.com/mod-audio/mod-plugin-builder --depth=1
      - name: Bootstrap toolchain
        run: |
          sed -i 's/CT_LOG_PROGRESS_BAR=y/CT_LOG_PROGRESS_BAR=n/' mod-plugin-builder/toolchain/generic-aarch64.config
          ./mod-plugin-builder/bootstrap.sh ${{ matrix.platform }} && ./mod-plugin-builder/.clean-install.sh ${{ matrix.platform }}
      - name: Set ARTIFACT_FILENAME
        run: |
          echo "ARTIFACT_FILENAME=$(echo bootstrap-linux-${{ matrix.container }}-${{ matrix.platform }} | sed 's/-darkglass-anagram//' | sed 's/:/-/g')" >> "${GITHUB_ENV}"
      - name: Pack bootstrap
        run: |
          tar -C ~/mod-workdir -czf ${{ env.ARTIFACT_FILENAME }}.tar.gz ${{ matrix.platform }}/host ${{ matrix.platform }}/target generic-aarch64/toolchain
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_FILENAME }}
          path: ${{ env.ARTIFACT_FILENAME }}.tar.gz

  examples:
    needs: bootstrap
    strategy:
      matrix:
        container: [debian:12, debian:13, ubuntu:22.04, ubuntu:24.04]
        platform: [darkglass-anagram, darkglass-anagram-debug]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.container }}
    steps:
      - uses: actions/checkout@v4
      - name: Set ARTIFACT_FILENAME
        run: |
          echo "ARTIFACT_FILENAME=$(echo bootstrap-linux-${{ matrix.container }}-${{ matrix.platform }} | sed 's/-darkglass-anagram//' | sed 's/:/-/g')" >> "${GITHUB_ENV}"
      - name: Download bootstrap
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_FILENAME }}
          path: ~/mod-workdir
      - name: Extract bootstrap
        shell: bash
        run: |
          tar -C ~/mod-workdir -xf ~/mod-workdir/${{ env.ARTIFACT_FILENAME }}.tar.gz
      - name: Enable KXStudio repositories
        run: |
          apt-get update -qq && \
            apt-get install -yqq gpgv wget
          wget https://launchpad.net/~kxstudio-debian/+archive/kxstudio/+files/kxstudio-repos_11.2.0_all.deb && \
            dpkg -i *.deb && \
            rm *.deb
      - name: Install dependencies (build and validation)
        run: |
          apt-get update -qq && \
            apt-get install -yqq \
                cmake g++ git libfontconfig-dev libfreetype6-dev libx11-dev libxcursor-dev libxinerama-dev libxrandr-dev pkg-config \
                lilv-utils lv2-dev lv2lint \
                darkglass-lv2-extensions kxstudio-lv2-extensions mod-lv2-extensions \
                qemu-user-static
      - name: Build examples
        run: |
          .github/workflows/ci-build-examples.sh ${{ matrix.platform }}
