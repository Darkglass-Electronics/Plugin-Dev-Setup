name: bootstrap-docker

on: [push, pull_request]

env:
  CACHE_VERSION: 6

jobs:
  bootstrap:
    strategy:
      matrix:
        debug: [false, true]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set DEBUG_SUFFIX
        run: |
          if [ "${{ matrix.debug }}" = "true" ]; then
            echo "DEBUG_SUFFIX=-debug" >> "${GITHUB_ENV}"
          fi
      - name: Set up cache
        uses: actions/cache@v4
        with:
          path: ~/docker
          key: bootstrap-docker${{ env.DEBUG_SUFFIX }}-v${{ env.CACHE_VERSION }}
      - name: Bootstrap through docker
        run: |
          if [ ! -e ~/docker/bootstrap-docker${{ env.DEBUG_SUFFIX }}.tar ]; then
            docker buildx build \
              --build-arg debug=${{ matrix.debug }} \
              --build-arg target=full \
              --tag "darkglass-anagram${{ env.DEBUG_SUFFIX }}" \
              docker
          fi
      - name: Export docker image
        shell: bash
        run: |
          if [ ! -e ~/docker/bootstrap-docker${{ env.DEBUG_SUFFIX }}.tar ]; then
            mkdir -p ~/docker
            docker save -o ~/docker/bootstrap-docker${{ env.DEBUG_SUFFIX }}.tar darkglass-anagram${{ env.DEBUG_SUFFIX }}
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: bootstrap-docker${{ env.DEBUG_SUFFIX }}
          path: ~/docker/bootstrap-docker${{ env.DEBUG_SUFFIX }}.tar

  examples:
    needs: bootstrap
    strategy:
      matrix:
        debug: [false, true]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set DEBUG_SUFFIX
        run: |
          if [ "${{ matrix.debug }}" = "true" ]; then
            echo "DEBUG_SUFFIX=-debug" >> "${GITHUB_ENV}"
          fi
      - name: Download bootstrap
        uses: actions/download-artifact@v4
        with:
          name: bootstrap-docker${{ env.DEBUG_SUFFIX }}
          path: ~/docker
      - name: Import bootstrap
        run: |
          docker load -i ~/docker/bootstrap-docker${{ env.DEBUG_SUFFIX }}.tar
      - name: Build examples
        shell: bash
        run: |
          docker run --rm -t -v $(pwd):/mnt darkglass-anagram${{ env.DEBUG_SUFFIX }} /mnt/.github/workflows/ci-build-examples.sh
